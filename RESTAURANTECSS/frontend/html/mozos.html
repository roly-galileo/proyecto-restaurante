<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sabor Casero - Panel de Mozos">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css">
    <title>Sabor Casero â€“ Panel de Mozos</title>
</head>
<body>

    <!-- ============ SIDEBAR ============ -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="logo-icon">ğŸ´</span>
            <span class="logo-text">Sabor Casero</span>
        </div>

        <nav class="sidebar-nav">
            <p class="nav-label">Mi Ãrea</p>
            <ul>
                <li><a href="#" class="nav-item active" data-section="mesas">
                    <span class="nav-icon">ğŸª‘</span><span>Mesas</span>
                </a></li>
                <li><a href="#" class="nav-item" data-section="pedidos">
                    <span class="nav-icon">ğŸ½</span><span>Pedidos</span>
                </a></li>
                <li><a href="#" class="nav-item" data-section="asistencia">
                    <span class="nav-icon">âœ…</span><span>Asistencia</span>
                </a></li>
            </ul>

            <p class="nav-label">Acceso RÃ¡pido</p>
            <ul>
                <li><a href="index.html" class="nav-item">
                    <span class="nav-icon">ğŸ </span><span>Ir al Sitio</span>
                </a></li>
            </ul>
        </nav>

        <div class="sidebar-user">
            <div class="user-avatar" id="userAvatar">M</div>
            <div class="user-info">
                <p class="user-name" id="userName">Mozo</p>
                <p class="user-role">Personal de Sala</p>
            </div>
            <button class="btn-logout" id="btnLogout" title="Cerrar sesiÃ³n" onclick="cerrarSesion()">ğŸšª</button>
        </div>
    </aside>

    <!-- ============ MAIN CONTENT ============ -->
    <div class="main-wrapper">

        <header class="topbar">
            <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                <span></span><span></span><span></span>
            </button>
            <div class="topbar-title">
                <h1 id="pageTitle">Panel de Sala</h1>
                <p id="pageBreadcrumb">Sabor Casero / Mozos</p>
            </div>
            <div class="topbar-actions">
                <span class="topbar-date" id="currentDate"></span>
                <span class="topbar-clock" id="currentTime"></span>
            </div>
        </header>

        <!-- ======================================================
             MESAS
        ====================================================== -->
        <section class="content-section active" id="section-mesas">
            <div class="section-intro">
                <h2>ğŸª‘ Estado de Mesas</h2>
                <p>Gestiona las mesas asignadas a tu Ã¡rea.</p>
            </div>

            <div class="toolbar">
                <div class="leyenda-mesas">
                    <span class="leyenda-item libre">Libre</span>
                    <span class="leyenda-item ocupada">Ocupada</span>
                    <span class="leyenda-item reservada">Reservada</span>
                </div>
                <button class="btn-primary btn-sm" onclick="abrirModal('mesa')">+ Abrir Mesa</button>
            </div>

            <div class="mesas-grid" id="mesasGrid"></div>
        </section>

        <!-- ======================================================
             PEDIDOS
        ====================================================== -->
        <section class="content-section" id="section-pedidos">
            <div class="section-intro">
                <h2>ğŸ½ Mis Pedidos</h2>
                <p>Pedidos asignados a tu Ã¡rea.</p>
            </div>

            <div class="cola-filtros">
                <button class="filtro-btn active" data-filtro="todos">Todos</button>
                <button class="filtro-btn" data-filtro="pendiente">ğŸ• Pendiente</button>
                <button class="filtro-btn" data-filtro="tomado">ğŸ‘¨â€ğŸ³ En Cocina</button>
                <button class="filtro-btn" data-filtro="listo">âœ… Listo</button>
            </div>

            <div class="table-wrap">
                <table class="data-table">
                    <thead><tr>
                        <th>Mesa</th><th>Platos</th><th>Estado</th><th>Hora</th><th>Acciones</th>
                    </tr></thead>
                    <tbody id="bodyPedidos"></tbody>
                </table>
            </div>
        </section>

        <!-- ======================================================
             ASISTENCIA
        ====================================================== -->
        <section class="content-section" id="section-asistencia">
            <div class="section-intro">
                <h2>âœ… Tu Asistencia</h2>
                <p>Registro de entrada y salida.</p>
            </div>

            <div class="asistencia-container" style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                <div class="dash-card" style="flex: 1; min-width: 200px; text-align: center;">
                    <p style="color: #999; margin: 0; font-size: 13px;">Hora de Entrada</p>
                    <p style="font-size: 32px; font-weight: bold; color: #D2691E; margin: 10px 0;" id="horaEntrada">--:--</p>
                    <button class="btn-primary" style="width: 100%;" onclick="registrarEntrada()">âœ… Marcar Entrada</button>
                </div>
                <div class="dash-card" style="flex: 1; min-width: 200px; text-align: center;">
                    <p style="color: #999; margin: 0; font-size: 13px;">Hora de Salida</p>
                    <p style="font-size: 32px; font-weight: bold; color: #D2691E; margin: 10px 0;" id="horaSalida">--:--</p>
                    <button class="btn-primary" style="width: 100%;" onclick="registrarSalida()">ğŸšª Marcar Salida</button>
                </div>
            </div>

            <div class="table-wrap">
                <table class="data-table">
                    <thead><tr>
                        <th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas Trab.</th><th>Estado</th>
                    </tr></thead>
                    <tbody id="bodyMiAsistencia"></tbody>
                </table>
            </div>
        </section>

    </div><!-- fin main-wrapper -->

    <!-- ======== MODAL GENÃ‰RICO ======== -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalBox">
            <div class="modal-header">
                <h3 id="modalTitle">Agregar</h3>
                <button class="close-btn" onclick="cerrarModal()">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <script src="../js/admin.js"></script>
    <script>
        /* ============================================
           MOZOS.JS - Panel del Mozo
        ============================================ */

        // Verificar que sea mozo
        function verificarMozo() {
            const rolId = sessionStorage.getItem('sc_user_role');
            if (rolId !== '3') {
                alert('No tienes permiso para acceder a esta pÃ¡gina');
                window.location.href = '../html/index.html';
            }
        }

        // Cerrar sesiÃ³n
        function cerrarSesion() {
            if (!confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) return;
            
            localStorage.removeItem('sc_session');
            localStorage.removeItem('sc_token');
            localStorage.removeItem('sc_refresh_token');
            localStorage.removeItem('sc_device_token');
            sessionStorage.removeItem('sc_user_role');
            sessionStorage.removeItem('sc_user_id');
            sessionStorage.removeItem('sc_user_name');
            
            window.location.href = 'login.html';
        }

        // Renderizar mesas asignadas al mozo
        function renderizarMesasMozo() {
            const mesasAsignadas = mesas.filter(m => true);

            const grid = document.getElementById('mesasGrid');
            if (!grid) return;

            grid.innerHTML = mesasAsignadas.map(mesa => {
                const classes = `mesa mesa-${mesa.estado}`;
                const icon = {
                    'libre': 'ğŸŸ¢',
                    'ocupada': 'ğŸ”´',
                    'reservada': 'ğŸŸ¡'
                }[mesa.estado] || 'ğŸŸ¤';

                return `
                    <div class="${classes}" onclick="abrirMesa(${mesa.num})" style="cursor: pointer;">
                        <div class="mesa-number">Mesa ${mesa.num}</div>
                        <div class="mesa-status">${icon}</div>
                        <div class="mesa-info">
                            <p>${mesa.personas} pers.</p>
                            <p style="font-size: 11px; opacity: 0.7;">${mesa.mozo}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Renderizar pedidos del mozo
        function renderizarPedidosMozo() {
            const misPedidos = pedidos;

            const tbody = document.getElementById('bodyPedidos');
            if (!tbody) return;

            const filtro = document.querySelector('.filtro-btn.active')?.dataset.filtro || 'todos';
            const pedidosFiltrados = filtro === 'todos' 
                ? misPedidos 
                : misPedidos.filter(p => p.estado === filtro);

            tbody.innerHTML = pedidosFiltrados.map(p => {
                const estados = {
                    'pendiente': 'ğŸ• Pendiente',
                    'tomado': 'ğŸ‘¨â€ğŸ³ En Cocina',
                    'listo': 'âœ… Listo',
                    'despachado': 'ğŸš€ Entregado'
                };

                const tiempoTranscurrido = Math.floor((Date.now() - p.inicio) / 60000);

                return `
                    <tr>
                        <td><strong>${p.mesa}</strong></td>
                        <td>${p.items.map(i => i.plato).join(', ')}</td>
                        <td>${estados[p.estado] || p.estado}</td>
                        <td>${tiempoTranscurrido} min</td>
                        <td>
                            ${p.estado === 'listo' ? `<button class="btn-sm" style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" onclick="marcarEntregado('${p.id}')">Entregar</button>` : '<span style="color: #999;">--</span>'}
                        </td>
                    </tr>
                `;
            }).join('');

            if (pedidosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No hay pedidos</td></tr>';
            }
        }

        // Renderizar asistencia del mozo
        function renderizarMiAsistencia() {
            const tbody = document.getElementById('bodyMiAsistencia');
            if (!tbody) return;

            const miAsistencia = [
                { fecha: '15/02', entrada: '08:30', salida: '17:00', horas: '8.5h', estado: 'âœ… Completo' },
                { fecha: '14/02', entrada: '08:15', salida: '16:45', horas: '8.5h', estado: 'âœ… Completo' },
                { fecha: '13/02', entrada: '08:45', salida: '17:30', horas: '8.75h', estado: 'âœ… Completo' },
            ];

            tbody.innerHTML = miAsistencia.map(a => `
                <tr>
                    <td>${a.fecha}</td>
                    <td>${a.entrada}</td>
                    <td>${a.salida}</td>
                    <td>${a.horas}</td>
                    <td>${a.estado}</td>
                </tr>
            `).join('');
        }

        // Marcar pedido como entregado
        function marcarEntregado(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido) {
                pedido.estado = 'despachado';
                showToast(`âœ… Pedido ${pedidoId} entregado`);
                renderizarPedidosMozo();
            }
        }

        // Registrar entrada
        function registrarEntrada() {
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-PE', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('horaEntrada').textContent = hora;
            document.getElementById('horaEntrada').style.color = '#4CAF50';
            showToast(`âœ… Entrada registrada: ${hora}`);
        }

        // Registrar salida
        function registrarSalida() {
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-PE', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('horaSalida').textContent = hora;
            document.getElementById('horaSalida').style.color = '#4CAF50';
            showToast(`âœ… Salida registrada: ${hora}`);
        }

        // Abrir mesa
        function abrirMesa(mesaNum) {
            showToast(`ğŸª‘ Abriendo mesa ${mesaNum}...`);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            verificarMozo();

            const sesion = localStorage.getItem('sc_session');
            if (sesion) {
                try {
                    const data = JSON.parse(sesion);
                    if (data.usuario) {
                        const nombreCompleto = `${data.usuario.nombre || ''} ${data.usuario.apellido || ''}`.trim();
                        document.getElementById('userName').textContent = nombreCompleto || data.usuario.nombre || 'Mozo';
                        document.getElementById('userAvatar').textContent = (data.usuario.nombre?.charAt(0) || 'M').toUpperCase();
                    }
                } catch (e) {
                    console.error('Error:', e);
                }
            }

            renderizarMesasMozo();
            renderizarPedidosMozo();
            renderizarMiAsistencia();

            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderizarPedidosMozo();
                });
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(`section-${section}`).classList.add('active');
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById('pageTitle').textContent = item.textContent.trim();
                });
            });

            setInterval(() => {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-PE');
                document.getElementById('currentDate').textContent = now.toLocaleDateString('es-PE');
            }, 1000);
        });
    </script>
</body>
</html>